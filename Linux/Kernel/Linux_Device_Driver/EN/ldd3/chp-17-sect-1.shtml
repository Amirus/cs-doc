<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>17.1. How snull Is Designed</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<head>
<link rel="stylesheet" type="text/css" href="../style/visited-green.css">
</head>
<div align=center>
<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<center>
<table width=100% height=90>
<tr style='display:none'>
<td style='display:xnone' id='banner' xalign=center style="background-image:url(/kernel_map.d/LKM3_2048.png);width:100%;height:90;opacity:0;filter:alpha(opacity=0);
cursor:pointer" onclick="top.location='http://www.makelinux.com/kernel_map?b'" /> 
</td> </tr>
<tr style='display:none'>
<td  id='banner2' style="opacity:0;filter:alpha(opacity=0);text-align:center;" /> 
<a target=_top href=http://www.makelinux.com/kernel_map_poster?b>
<span style="font-weight:bold"><span style="display:block;font-size:large" >Poster of Linux kernel</span>The best gift for a Linux geek</span>
</a>
</td> </tr>
<tr style='zdisplay:xnone' >
<td  id='banner3' align=center /> 
<a Xtarget=_top href="http://www.makelinux.com/kernel_map_poster?b"> <img target=_top src="http://www.makelinux.net/kernel_map.d/poster2.png" border=0></a>
</td></tr>
</table>
</center>
<script type='text/javascript' src='../common/fade.js'></script>
<script type=text/javascript>

	var banner = document.getElementById('banner');
	banner.style.backgroundPosition="50% 50%";
	banner.style.backgroundPosition=100*Math.random()+"% "+100*Math.random(100)+"%";
	//fade('banner');
    	//setTimeout("fade('banner')",1000);
    	//setTimeout("fade('banner2')",1000);
</script>

<script type="text/javascript">
var a = new Array();
a[0]='<a href=http://www.linuxdriver.co.il/>www.LinuxDriver.co.il - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot. In Tel-Aviv</a>';
a[1]='<a href=http://www.MakeLinux.net/>www.MakeLinux.net - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot</a>';
a[2]='<a href="http://www.amazon.com/gp/product/0672329468?ie=UTF8&tag=makelinux-20&linkCode=as2&camp=1789&creative=390957&creativeASIN=0672329468">New book <b>Linux Kernel Development</b> (3rd Edition) 2010</a><img src="http://www.assoc-amazon.com/e/ir?t=makelinux-20&l=as2&o=1&a=0672329468" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />';
a[3]='';
google_ad_width = 728;
google_ad_height = 1;
if ( 0) { 
document.write("<center>");
if (  geoip_country_code()=="IL" ) {
	if ( Math.random() > 0.5 ) document.write(a[0]+"<br>"); else document.write(a[2]);;
	google_ad_width = 728;
	google_ad_height = 1;
} else { 
	if ( Math.random() > 0.5 ) {
		if ( Math.random() > 0.5 ) document.write(a[1]+"<br>"); else document.write(a[2]);
		google_ad_width = 728;
		google_ad_height = 1;
	} else {
		google_ad_client = "pub-5656623102424572";
		/* 728x90, created 4/4/08 */
		google_ad_slot = "6613964975";
		google_ad_width = 728;
		google_ad_height = 100;
	}
}
	document.write("</center>");
}
</script>
<!--
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> </script>
-->


</div>
<!-- 
Hi surfer
<script type="text/javascript"> 
	try {
	document.write(" from <i><b>" + geoip_city()+"</b></i>"); 
	} catch (e) {
	}
</script>, please visit -->


<xhr>
<script type="text/javascript">
	s = document.location.href.lastIndexOf("/");
	a = document.location.href.substring(0,s+1);
	b = document.location.href.substring(s+1);
if ( document.location == top.location  ) {
	//alert(a + " -- " + b);
	document.write("<a href="http://www.makelinux.net/ldd3/+&#32;a&#32;+"?u=" +b + "> &lt; open Table of Content</a>");
	//top.location = a + "?u=" +b;
} else {
	document.write("<a target=_top href="http://www.makelinux.net/ldd3/+document.location&#32;+"> &lt; full page </a>");
}
function addLoadEvent(func) 
{
	var oldonload = window.onload;
	if (typeof window.onload != 'function') {
		window.onload = func;
	} else {
		window.onload = function() {
			oldonload();
			func();
		}
	}
}

addLoadEvent(  function() { 
		try {
		} catch (e) {
	}
}
);


</script>
<span style='display:none;background:#BBFFFF;color:black;position:absolute;right:0;' ><a target=_main href=http://www.makelinux.net/kernel_map?src=ldd3>&nbsp;Linux kernel map&nbsp;</a></span><br>
<script type="text/javascript">
</script>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"> </script>
<script type="text/javascript"> _uacct = "UA-839593-1"; if (typeof(urchinTracker) == 'function') urchinTracker();</script>
<script type=text/javascript>
	// document.write("<img src=http://const.homelinux.net/1.png?REF="+top.document.referrer+" height=0 width=0 border=0 />");
</script>


<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr >
<td class="v2" align="left" width="30%">
<a href="chp-17.shtml"> &#8678; prev </a>
</td>
<td class="v2" align="center" width="40%">
<a href="index.html" target=_parent style="text-decoration:none;text-underline:none"> &#8689; home </a>
</td>
<td class="v2" align="right" width="30%">
<a href="chp-17-sect-2.shtml"> next &#8680; </a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><TR><td valign="top"><a name="chp-17-sect-1"></a>
<h3 class="docSection1Title">17.1. How snull Is Designed</H3>

<p class="docText">This section discusses the <a name="chp-17-ITERM-7468"></a> <a name="chp-17-ITERM-7469"></a>
<a name="chp-17-ITERM-7470"></a> <a name="chp-17-ITERM-7471"></a>design
concepts that led to the <span class="docEmphasis">snull</span> network
interface. Although this information might appear to be of marginal
use, failing to understand it might lead to problems when you play
with the sample code.</p>

<p class="docText"><a name="chp-17-ITERM-7472"></a>
<a name="chp-17-ITERM-7473"></a>The
first, and most important, design decision was that the sample
interfaces should remain independent of real hardware, just like most
of the sample code used in this book. This constraint led to
something that resembles the loopback interface.
<span class="docEmphasis">snull</span> is not a loopback interface; however, it
simulates conversations with real remote hosts in order to better
demonstrate the task of writing a network driver. The Linux loopback
driver is actually quite simple; it can be found in
<i>drivers/net/loopback.c</I>.</p>

<p class="docText">Another feature of <span class="docEmphasis">snull</span> is that it supports
only IP traffic. This is a consequence of the internal workings of
the interfaceâ€”<span class="docEmphasis">snull</span> has to look inside and
interpret the packets to properly emulate a pair of hardware
interfaces. Real interfaces don't depend on the
protocol being transmitted, and this limitation of
<span class="docEmphasis">snull</span> doesn't affect the
fragments of code shown in this chapter.</P>

<a name="chp-17-sect-1.1"></a>
<h4 class="docSection2Title">17.1.1. Assigning IP Numbers</h4>

<p class="docText">The <span class="docEmphasis">snull</span> module creates
<a name="chp-17-ITERM-7474"></a>
<a name="chp-17-ITERM-7475"></a>two interfaces. These
interfaces are different from a simple loopback, in that whatever you
transmit through one of the interfaces loops back to the other one,
not to itself. It looks like you have two external links, but
actually your computer is replying to itself.</p>

<p class="docText">Unfortunately, this effect can't be accomplished
through IP number assignments alone, because the kernel
wouldn't send out a packet through interface A that
was directed to its own interface B. Instead, it would use the
loopback channel without passing through <span class="docEmphasis">snull</span>.
To be able to establish a communication through the
<span class="docEmphasis">snull</span> interfaces, the source and destination
addresses need to be modified during data transmission. In other
words, packets sent through one of the interfaces should be received
by the other, but the receiver of the outgoing packet
shouldn't be recognized as the local host. The same
applies to the source address of received packets.</p>

<p class="docText">To achieve this kind of "hidden
loopback," the <span class="docEmphasis">snull</span> interface
toggles the least significant bit of the third octet of both the
source and destination addresses; that is, it changes both the
network number and the host number of class C IP numbers. The net
effect is that packets sent to network A (connected to
<tt>sn0</tt>, the first interface) appear on the
<tt>sn1</tt> interface as packets belonging to network B.</p>

<p class="docText">To avoid dealing with too many numbers, let's assign
symbolic<a name="chp-17-ITERM-7476"></a> names to the IP numbers involved:</p>

<ul><li><p class="docList"><tt>snullnet0</tt><a name="chp-17-ITERM-7477"></a> is the network that is connected to the
<tt>sn0</tt> interface. Similarly,
<tt>snullnet1</tt> is the network connected to
<tt>sn1</tt>. The addresses of these networks should differ
only in the least significant bit of the third octet. These networks
must have 24-bit netmasks.</p></li><li><p class="docList"><tt>local0</tt><a name="chp-17-ITERM-7478"></a> is the IP address assigned to the
<tt>sn0</tt> interface; it belongs to
<tt>snullnet0</tt>. The address associated with
<tt>sn1</tt> is <tt>local1</tt>.
<tt>local0</tt> and <tt>local1</tt> must differ
in the least significant bit of their third octet and in the fourth
octet.</p></li><LI><p class="docList"><tt>remote0</tt><a name="chp-17-ITERM-7479"></a> is a host in
<tt>snullnet0</tt>, and its fourth octet is the same as
that of <tt>local1</tt>. Any packet sent to
<tt>remote0</tt> reaches <tt>local1</tt> after
its network address has been modified by the interface code. The host
<tt>remote1</tt> belongs to <tt>snullnet1</tt>,
and its fourth octet is the same as that of
<tt>local0</tt>.</p></LI></UL>
<p class="docText">The operation of
the<a name="chp-17-ITERM-7480"></a> <a name="chp-17-ITERM-7481"></a> <span class="docEmphasis">snull</span>
interfaces is depicted in <a class="docLink" href="chp-17-sect-1.shtml#chp-17-FIG-1">Figure 17-1</a>, in which the hostname
associated with each interface is printed near the interface name.</p>

<a name="chp-17-FIG-1"></a><p><center>
<h5 class="docFigureTitle">Figure 17-1. How a host sees its interfaces</H5>
<img border="0" alt="" width="467" height="292" SRC="images/0596005903/figs/ldr3_1701.gif"></center></p><BR>

<p class="docText"><a name="chp-17-ITERM-7482"></a>
<a name="chp-17-ITERM-7483"></a>Here
are possible values for the network numbers. Once you put these lines
in <I>/etc/networks</I>, you can call your networks by
name. The values were chosen from the range of numbers reserved for
private use.</p>

<pre>snullnet0       192.168.0.0
snullnet1       192.168.1.0</pre><br>


<p class="docText">The following are possible host numbers to put into
<i>/etc/hosts</i>:</P>

<pre>192.168.0.1   local0
192.168.0.2   remote0
192.168.1.2   local1
192.168.1.1   remote1</pre><BR>


<p class="docText">The important feature of these numbers is that the host portion of
<tt>local0</tt> is the same as that of
<tt>remote1</tt>, and the host portion of
<tt>local1</tt> is the same as that of
<tt>remote0</tt>. You can use completely different numbers
as long as this relationship applies.</P>

<p class="docText">Be careful, however, if your
<a name="chp-17-ITERM-7484"></a>computer is already connected to a
network. The numbers you choose might be real Internet or intranet
numbers, and assigning them to your interfaces prevents communication
with the real hosts. For example, although the numbers just shown are
not routable Internet numbers, they could already be used by your
private network.</p>

<p class="docText">Whatever numbers you choose, you can correctly set up the interfaces
for operation by issuing the following commands:</P>

<a name="chp-17-ITERM-7485"></a><a name="chp-17-ITERM-7486"></a><pre>ifconfig sn0 local0
ifconfig sn1 local1</pre><BR>


<p class="docText">You may need to add the <tt>netmask 255.255.255.0</tt>
parameter if the address range chosen is not a class C range.</p>

<p class="docText">At this point, the "remote" end of
the interface can be reached. The following screendump shows how a
host reaches <tt>remote0</tt> and
<tt>remote1</tt> through the <span class="docEmphasis">snull</span>
interface:</p>

<pre>morgana% <b>ping -c 2 remote0</b>
64 bytes from 192.168.0.99: icmp_seq=0 ttl=64 time=1.6 ms
64 bytes from 192.168.0.99: icmp_seq=1 ttl=64 time=0.9 ms
2 packets transmitted, 2 packets received, 0% packet loss

morgana% <B>ping -c 2 remote1</b>
64 bytes from 192.168.1.88: icmp_seq=0 ttl=64 time=1.8 ms
64 bytes from 192.168.1.88: icmp_seq=1 ttl=64 time=0.9 ms
2 packets transmitted, 2 packets received, 0% packet loss</pre><br>


<p class="docText">Note that you won't be able to reach any other
"host" belonging to the two
networks, because the packets are discarded by your computer after
the address has been modified and the packet has been received. For
example, a packet aimed at 192.168.0.32 will leave through
<tt>sn0</tt> and reappear at <tt>sn1</tt> with a
destination address of 192.168.1.32, which is not a local address for
the host computer.</p>


<a name="chp-17-sect-1.2"></a>
<a name="chp-17-ITERM-7487"></a><a name="chp-17-ITERM-7488"></a><H4 class="docSection2Title">17.1.2. The Physical Transport of Packets</h4>

<p class="docText"><a name="chp-17-ITERM-7489"></a><a name="chp-17-ITERM-7490"></a><a name="chp-17-ITERM-7491"></a>As
<a name="chp-17-ITERM-7492"></a>far
as data transport is concerned, the <span class="docEmphasis">snull</span>
interfaces belong to the Ethernet class.</p>

<p class="docText"><a name="chp-17-ITERM-7493"></a><span class="docEmphasis">snull</span> emulates
Ethernet because the vast majority of existing networksâ€”at
least the segments that a workstation connects toâ€”are based on
Ethernet technology, be it 10base-T, 100base-T, or Gigabit.
Additionally, the kernel offers some generalized support for Ethernet
devices, and there's no reason not to use it. The
advantage of being an Ethernet device is so strong that even the
<span class="docEmphasis">plip</span> interface (the interface that uses the
printer ports) declares itself as an Ethernet device.</P>

<p class="docText"><a name="chp-17-ITERM-7494"></a>
<a name="chp-17-ITERM-7495"></a>The
last advantage of using the Ethernet setup for
<span class="docEmphasis">snull</span> is that you can run
<span class="docEmphasis">tcpdump</span> on the interface to see the packets go
by. Watching the interfaces with <span class="docEmphasis">tcpdump</span> can be
a useful way to see how the two interfaces work.</p>

<p class="docText">As was mentioned previously, <span class="docEmphasis">snull</span> works only
with IP packets. This limitation is a result of the fact that
<span class="docEmphasis">snull</span> snoops in the packets and even modifies
them, in order for the code to work. The code modifies the source,
destination, and checksum in the IP header of each packet without
checking whether it actually conveys IP information. This
quick-and-dirty data modification destroys non-IP packets. If you
want to deliver other protocols<a name="chp-17-ITERM-7496"></a> <a name="chp-17-ITERM-7497"></a> <a name="chp-17-ITERM-7498"></a> <a name="chp-17-ITERM-7499"></a> through <span class="docEmphasis">snull</span>,
you must modify the module's source code.</P>



<ul></ul></td></tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr >
<td class="v2" align="left" width="30%">
<a href="chp-17.shtml"> &#8678; prev </a>
</td>
<td class="v2" align="center" width="40%">
<a href="index.html" target=_parent style="text-decoration:none;text-underline:none"> &#8689; home </a>
</td>
<td class="v2" align="right" width="30%">
<a href="chp-17-sect-2.shtml"> next &#8680; </a>
</td>
</tr>
</table>
<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<center>
<table width=100% height=90>
<tr style='display:none'>
<td style='display:xnone' id='banner' xalign=center style="background-image:url(/kernel_map.d/LKM3_2048.png);width:100%;height:90;opacity:0;filter:alpha(opacity=0);
cursor:pointer" onclick="top.location='http://www.makelinux.com/kernel_map?b'" /> 
</td> </tr>
<tr style='display:none'>
<td  id='banner2' style="opacity:0;filter:alpha(opacity=0);text-align:center;" /> 
<a target=_top href=http://www.makelinux.com/kernel_map_poster?b>
<span style="font-weight:bold"><span style="display:block;font-size:large" >Poster of Linux kernel</span>The best gift for a Linux geek</span>
</a>
</td> </tr>
<tr style='zdisplay:xnone' >
<td  id='banner3' align=center /> 
<a Xtarget=_top href="http://www.makelinux.com/kernel_map_poster?b"> <img target=_top src="http://www.makelinux.net/kernel_map.d/poster2.png" border=0></a>
</td></tr>
</table>
</center>
<script type='text/javascript' src='../common/fade.js'></script>
<script type=text/javascript>

	var banner = document.getElementById('banner');
	banner.style.backgroundPosition="50% 50%";
	banner.style.backgroundPosition=100*Math.random()+"% "+100*Math.random(100)+"%";
	//fade('banner');
    	//setTimeout("fade('banner')",1000);
    	//setTimeout("fade('banner2')",1000);
</script>

<script type="text/javascript">
var a = new Array();
a[0]='<a href=http://www.linuxdriver.co.il/>www.LinuxDriver.co.il - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot. In Tel-Aviv</a>';
a[1]='<a href=http://www.MakeLinux.net/>www.MakeLinux.net - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot</a>';
a[2]='<a href="http://www.amazon.com/gp/product/0672329468?ie=UTF8&tag=makelinux-20&linkCode=as2&camp=1789&creative=390957&creativeASIN=0672329468">New book <b>Linux Kernel Development</b> (3rd Edition) 2010</a><img src="http://www.assoc-amazon.com/e/ir?t=makelinux-20&l=as2&o=1&a=0672329468" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />';
a[3]='';
google_ad_width = 728;
google_ad_height = 1;
if ( 0) { 
document.write("<center>");
if (  geoip_country_code()=="IL" ) {
	if ( Math.random() > 0.5 ) document.write(a[0]+"<br>"); else document.write(a[2]);;
	google_ad_width = 728;
	google_ad_height = 1;
} else { 
	if ( Math.random() > 0.5 ) {
		if ( Math.random() > 0.5 ) document.write(a[1]+"<br>"); else document.write(a[2]);
		google_ad_width = 728;
		google_ad_height = 1;
	} else {
		google_ad_client = "pub-5656623102424572";
		/* 728x90, created 4/4/08 */
		google_ad_slot = "6613964975";
		google_ad_width = 728;
		google_ad_height = 100;
	}
}
	document.write("</center>");
}
</script>
<!--
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> </script>
-->



<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<script type="text/javascript" >
{
	var os, br, ua = navigator.userAgent;

	if (ua.indexOf("Linux")!=-1) os="Linux";
	if (ua.indexOf("Windows")!=-1) os="Windows";
	if (ua.indexOf("Mac")!=-1) os="Mac";

	if (ua.indexOf("Gecko")!=-1) br="Gecko";
	if (ua.indexOf("Firefox")!=-1) br="Firefox";
	if (ua.indexOf("WebKit")!=-1) br="WebKit";
	if (ua.indexOf("MSIE")!=-1) br="MSIE";
	if (ua.indexOf("Safari")!=-1) br="Safari";
	if (ua.indexOf("Chrome")!=-1) br="Chrome";
	if (ua.indexOf("Konqueror")!=-1) br="Konqueror";
	if (ua.indexOf("Opera")!=-1) br="Opera";

	function query_var(query, variable) 
	{
		var vars = query.replace(/\?/g,"&").replace(/%20/g,"+").split("&");
		for (var i=0;i<vars.length;i++) {
			var pair = vars[i].split("=");
			if (pair[0] == variable) {
				return pair[1];
			}

		} 
	}
	var RQ="";
	q = query_var(top.document.referrer,'q');
	if ( q != undefined)
		RQ = ".&Q=" + q
	else if (top.document.referrer.length)
	
		RQ = ".&R=" + top.document.referrer;
	var traceimg= new Image();
	try {
		traceimg.src="http://const.homelinux.net/1.png?U="
			+ br + "-" + os 
			+"."+geoip_region_name().replace(/ /g,"_") 
			+"."+geoip_country_code()
			+ RQ ;
	} catch (e) {
	}
}
</script>


</body>
</html>
