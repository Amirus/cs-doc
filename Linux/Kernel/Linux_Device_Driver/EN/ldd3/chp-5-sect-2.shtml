<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>5.2. Concurrency and Its Management</title>
<link rel="STYLESHEET" type="text/css" href="images/style.css">
<link rel="STYLESHEET" type="text/css" href="images/docsafari.css">
</head>
<body >
<head>
<link rel="stylesheet" type="text/css" href="../style/visited-green.css">
</head>
<div align=center>
<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<center>
<table width=100% height=90>
<tr style='display:none'>
<td style='display:xnone' id='banner' xalign=center style="background-image:url(/kernel_map.d/LKM3_2048.png);width:100%;height:90;opacity:0;filter:alpha(opacity=0);
cursor:pointer" onclick="top.location='http://www.makelinux.com/kernel_map?b'" /> 
</td> </tr>
<tr style='display:none'>
<td  id='banner2' style="opacity:0;filter:alpha(opacity=0);text-align:center;" /> 
<a target=_top href=http://www.makelinux.com/kernel_map_poster?b>
<span style="font-weight:bold"><span style="display:block;font-size:large" >Poster of Linux kernel</span>The best gift for a Linux geek</span>
</a>
</td> </tr>
<tr style='zdisplay:xnone' >
<td  id='banner3' align=center /> 
<a Xtarget=_top href="http://www.makelinux.com/kernel_map_poster?b"> <img target=_top src="http://www.makelinux.net/kernel_map.d/poster2.png" border=0></a>
</td></tr>
</table>
</center>
<script type='text/javascript' src='../common/fade.js'></script>
<script type=text/javascript>

	var banner = document.getElementById('banner');
	banner.style.backgroundPosition="50% 50%";
	banner.style.backgroundPosition=100*Math.random()+"% "+100*Math.random(100)+"%";
	//fade('banner');
    	//setTimeout("fade('banner')",1000);
    	//setTimeout("fade('banner2')",1000);
</script>

<script type="text/javascript">
var a = new Array();
a[0]='<a href=http://www.linuxdriver.co.il/>www.LinuxDriver.co.il - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot. In Tel-Aviv</a>';
a[1]='<a href=http://www.MakeLinux.net/>www.MakeLinux.net - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot</a>';
a[2]='<a href="http://www.amazon.com/gp/product/0672329468?ie=UTF8&tag=makelinux-20&linkCode=as2&camp=1789&creative=390957&creativeASIN=0672329468">New book <b>Linux Kernel Development</b> (3rd Edition) 2010</a><img src="http://www.assoc-amazon.com/e/ir?t=makelinux-20&l=as2&o=1&a=0672329468" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />';
a[3]='';
google_ad_width = 728;
google_ad_height = 1;
if ( 0) { 
document.write("<center>");
if (  geoip_country_code()=="IL" ) {
	if ( Math.random() > 0.5 ) document.write(a[0]+"<br>"); else document.write(a[2]);;
	google_ad_width = 728;
	google_ad_height = 1;
} else { 
	if ( Math.random() > 0.5 ) {
		if ( Math.random() > 0.5 ) document.write(a[1]+"<br>"); else document.write(a[2]);
		google_ad_width = 728;
		google_ad_height = 1;
	} else {
		google_ad_client = "pub-5656623102424572";
		/* 728x90, created 4/4/08 */
		google_ad_slot = "6613964975";
		google_ad_width = 728;
		google_ad_height = 100;
	}
}
	document.write("</center>");
}
</script>
<!--
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> </script>
-->


</div>
<!-- 
Hi surfer
<script type="text/javascript"> 
	try {
	document.write(" from <i><b>" + geoip_city()+"</b></i>"); 
	} catch (e) {
	}
</script>, please visit -->


<xhr>
<script type="text/javascript">
	s = document.location.href.lastIndexOf("/");
	a = document.location.href.substring(0,s+1);
	b = document.location.href.substring(s+1);
if ( document.location == top.location  ) {
	//alert(a + " -- " + b);
	document.write("<a href="http://www.makelinux.net/ldd3/+&#32;a&#32;+"?u=" +b + "> &lt; open Table of Content</a>");
	//top.location = a + "?u=" +b;
} else {
	document.write("<a target=_top href="http://www.makelinux.net/ldd3/+document.location&#32;+"> &lt; full page </a>");
}
function addLoadEvent(func) 
{
	var oldonload = window.onload;
	if (typeof window.onload != 'function') {
		window.onload = func;
	} else {
		window.onload = function() {
			oldonload();
			func();
		}
	}
}

addLoadEvent(  function() { 
		try {
		} catch (e) {
	}
}
);


</script>
<span style='display:none;background:#BBFFFF;color:black;position:absolute;right:0;' ><a target=_main href=http://www.makelinux.net/kernel_map?src=ldd3>&nbsp;Linux kernel map&nbsp;</a></span><br>
<script type="text/javascript">
</script>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"> </script>
<script type="text/javascript"> _uacct = "UA-839593-1"; if (typeof(urchinTracker) == 'function') urchinTracker();</script>
<script type=text/javascript>
	// document.write("<img src=http://const.homelinux.net/1.png?REF="+top.document.referrer+" height=0 width=0 border=0 />");
</script>


<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr >
<td class="v2" align="left" width="30%">
<a href="chp-5-sect-1.shtml"> &#8678; prev </a>
</td>
<td class="v2" align="center" width="40%">
<a href="index.html" target=_parent style="text-decoration:none;text-underline:none"> &#8689; home </a>
</td>
<td class="v2" align="right" width="30%">
<a href="chp-5-sect-3.shtml"> next &#8680; </a>
</td>
</tr>
</table>
<br>
<table width="100%" border="0" cellspacing="0" cellpadding="0"><TR><TD valign="top"><a name="chp-5-sect-2"></a>
<h3 class="docSection1Title">5.2. Concurrency and Its Management</h3>

<p class="docText">In a modern Linux system, <a name="chp-5-ITERM-4952"></a>
<a name="chp-5-ITERM-4953"></a>
<a name="chp-5-ITERM-4954"></a>
<a name="chp-5-ITERM-4955"></a> <a name="chp-5-ITERM-4956"></a>there
are numerous sources of concurrency and, therefore, possible race
conditions. Multiple user-space processes are running, and they can
access your code in surprising combinations of ways. SMP systems can
be executing your code simultaneously on different processors. Kernel
code is preemptible; your driver's code can lose the
processor at any time, and the process that replaces it could also be
running in your driver. Device interrupts are asynchronous events
that can cause concurrent execution of your code. The kernel also
provides various mechanisms for delayed code execution, such as
workqueues, tasklets, and timers, which can cause your code to run at
any time in ways unrelated to what the current process is doing. In
the modern, hot-pluggable world, your device could simply disappear
while you are in the middle of working with it.</p>

<p class="docText">Avoidance of race conditions can be an intimidating task. In a world
where anything can happen at any time, how does a driver programmer
avoid the creation of absolute chaos? As it turns out, most race
conditions can be avoided through some thought, the
kernel's concurrency control primitives, and the
application of a few basic principles. We'll start
with the principles first, then get into the specifics of how to
apply them.</p>

<p class="docText">Race conditions come about as a result of shared access to resources.
When two threads of execution<sup class="docFootnote"><a class="docLink" href="chp-5-sect-2.shtml#chp-5-FNOTE-1">[1]</a></sup> have a reason to work with the same data
structures (or hardware resources), the potential for mixups always
exists. So the first rule of thumb to keep in mind as you design your
driver is to avoid shared resources whenever possible. If there is no
concurrent access, there can be no race conditions. So
carefully-written kernel code should have a minimum of
<a name="chp-5-ITERM-4957"></a>sharing.
The most obvious application of this idea is to avoid the use of
global variables. If you put a resource in a place where more than
one thread of execution can find it, there should be a strong reason
for doing so.</P><blockquote><p class="docFootnote"><sup><a name="chp-5-FNOTE-1">[1]</a></sup> For the purposes of
this chapter, a "thread" of
execution is any context that is running code. Each process is
clearly a thread of execution, but so is an interrupt handler or
other code running in response to an asynchronous kernel
event.</P></blockquote>

<p class="docText">The fact of the matter is, however, that such sharing is often
required. Hardware resources are, by their nature, shared, and
software resources also must often be available to more than one
thread. Bear in mind as well that global variables are far from the
only way to share data; any time your code passes a pointer to some
other part of the kernel, it is potentially creating a new sharing
situation. Sharing is a fact of life.</P>

<p class="docText">Here is the hard rule of resource sharing: any time that a hardware
or software resource is shared beyond a single thread of execution,
and the possibility exists that one thread could encounter an
inconsistent view of that resource, you must explicitly manage access
to that resource. In the <span class="docEmphasis">scull</span> example above,
process B's view of the situation is inconsistent;
unaware that process A has already allocated memory for the (shared)
device, it performs its own allocation and overwrites
A's work. In this case, we must control access to
the <span class="docEmphasis">scull</span> data structure. We need to arrange
things so that the code either sees memory that has been allocated or
knows that no memory has been <span class="docEmphasis">or will be</span>
allocated by anybody else. The usual technique for
<a name="chp-5-ITERM-4958"></a>
<a name="chp-5-ITERM-4959"></a>
<a name="chp-5-ITERM-4960"></a>
<a name="chp-5-ITERM-4961"></a>access
management is called <i>locking</I> or
<I>mutual exclusion</i>â€”making sure that only
one thread of execution can manipulate a shared resource at any time.
Much of the rest of this chapter will be devoted to locking.</p>

<p class="docText">First, however, we must briefly consider one other important rule.
When kernel code creates an object that will be shared with any other
part of the kernel, that object must continue to exist (and function
properly) until it is known that no outside references to it exist.
The instant that <span class="docEmphasis">scull</span> makes its devices
available, it must be prepared to handle requests on those devices.
And <span class="docEmphasis">scull</span> must continue to be able to handle
requests on its devices until it knows that no reference (such as
open user-space files) to those devices exists. Two requirements
<a name="chp-5-ITERM-4962"></a>
<a name="chp-5-ITERM-4963"></a>come
out of this rule: no object can be made available to the kernel until
it is in a state where it can function properly, and references to
such objects must be tracked. In most cases, you'll
find that the kernel handles reference counting for you, but there
are always exceptions.</p>

<p class="docText">Following the above rules requires planning and careful attention to
detail. It is easy to be surprised by concurrent access to resources
you hadn't realized were shared. With some effort,
however, most<a name="chp-5-ITERM-4964"></a> <a name="chp-5-ITERM-4965"></a> <a name="chp-5-ITERM-4966"></a> <a name="chp-5-ITERM-4967"></a> <a name="chp-5-ITERM-4968"></a> race conditions can be headed
<a name="chp-5-ITERM-4969"></a>off
before they bite youâ€”or your users.</p>


<UL></ul></td></TR></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e6e6e6">
<tr >
<td class="v2" align="left" width="30%">
<a href="chp-5-sect-1.shtml"> &#8678; prev </a>
</td>
<td class="v2" align="center" width="40%">
<a href="index.html" target=_parent style="text-decoration:none;text-underline:none"> &#8689; home </a>
</td>
<td class="v2" align="right" width="30%">
<a href="chp-5-sect-3.shtml"> next &#8680; </a>
</td>
</tr>
</table>
<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<center>
<table width=100% height=90>
<tr style='display:none'>
<td style='display:xnone' id='banner' xalign=center style="background-image:url(/kernel_map.d/LKM3_2048.png);width:100%;height:90;opacity:0;filter:alpha(opacity=0);
cursor:pointer" onclick="top.location='http://www.makelinux.com/kernel_map?b'" /> 
</td> </tr>
<tr style='display:none'>
<td  id='banner2' style="opacity:0;filter:alpha(opacity=0);text-align:center;" /> 
<a target=_top href=http://www.makelinux.com/kernel_map_poster?b>
<span style="font-weight:bold"><span style="display:block;font-size:large" >Poster of Linux kernel</span>The best gift for a Linux geek</span>
</a>
</td> </tr>
<tr style='zdisplay:xnone' >
<td  id='banner3' align=center /> 
<a Xtarget=_top href="http://www.makelinux.com/kernel_map_poster?b"> <img target=_top src="http://www.makelinux.net/kernel_map.d/poster2.png" border=0></a>
</td></tr>
</table>
</center>
<script type='text/javascript' src='../common/fade.js'></script>
<script type=text/javascript>

	var banner = document.getElementById('banner');
	banner.style.backgroundPosition="50% 50%";
	banner.style.backgroundPosition=100*Math.random()+"% "+100*Math.random(100)+"%";
	//fade('banner');
    	//setTimeout("fade('banner')",1000);
    	//setTimeout("fade('banner2')",1000);
</script>

<script type="text/javascript">
var a = new Array();
a[0]='<a href=http://www.linuxdriver.co.il/>www.LinuxDriver.co.il - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot. In Tel-Aviv</a>';
a[1]='<a href=http://www.MakeLinux.net/>www.MakeLinux.net - Embedded Linux solutions: Drivers, Media Streaming, Fast Boot</a>';
a[2]='<a href="http://www.amazon.com/gp/product/0672329468?ie=UTF8&tag=makelinux-20&linkCode=as2&camp=1789&creative=390957&creativeASIN=0672329468">New book <b>Linux Kernel Development</b> (3rd Edition) 2010</a><img src="http://www.assoc-amazon.com/e/ir?t=makelinux-20&l=as2&o=1&a=0672329468" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />';
a[3]='';
google_ad_width = 728;
google_ad_height = 1;
if ( 0) { 
document.write("<center>");
if (  geoip_country_code()=="IL" ) {
	if ( Math.random() > 0.5 ) document.write(a[0]+"<br>"); else document.write(a[2]);;
	google_ad_width = 728;
	google_ad_height = 1;
} else { 
	if ( Math.random() > 0.5 ) {
		if ( Math.random() > 0.5 ) document.write(a[1]+"<br>"); else document.write(a[2]);
		google_ad_width = 728;
		google_ad_height = 1;
	} else {
		google_ad_client = "pub-5656623102424572";
		/* 728x90, created 4/4/08 */
		google_ad_slot = "6613964975";
		google_ad_width = 728;
		google_ad_height = 100;
	}
}
	document.write("</center>");
}
</script>
<!--
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> </script>
-->



<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<script type="text/javascript" >
{
	var os, br, ua = navigator.userAgent;

	if (ua.indexOf("Linux")!=-1) os="Linux";
	if (ua.indexOf("Windows")!=-1) os="Windows";
	if (ua.indexOf("Mac")!=-1) os="Mac";

	if (ua.indexOf("Gecko")!=-1) br="Gecko";
	if (ua.indexOf("Firefox")!=-1) br="Firefox";
	if (ua.indexOf("WebKit")!=-1) br="WebKit";
	if (ua.indexOf("MSIE")!=-1) br="MSIE";
	if (ua.indexOf("Safari")!=-1) br="Safari";
	if (ua.indexOf("Chrome")!=-1) br="Chrome";
	if (ua.indexOf("Konqueror")!=-1) br="Konqueror";
	if (ua.indexOf("Opera")!=-1) br="Opera";

	function query_var(query, variable) 
	{
		var vars = query.replace(/\?/g,"&").replace(/%20/g,"+").split("&");
		for (var i=0;i<vars.length;i++) {
			var pair = vars[i].split("=");
			if (pair[0] == variable) {
				return pair[1];
			}

		} 
	}
	var RQ="";
	q = query_var(top.document.referrer,'q');
	if ( q != undefined)
		RQ = ".&Q=" + q
	else if (top.document.referrer.length)
	
		RQ = ".&R=" + top.document.referrer;
	var traceimg= new Image();
	try {
		traceimg.src="http://const.homelinux.net/1.png?U="
			+ br + "-" + os 
			+"."+geoip_region_name().replace(/ /g,"_") 
			+"."+geoip_country_code()
			+ RQ ;
	} catch (e) {
	}
}
</script>


</body>
</html>
