<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=GB2312">
		<title>
			Bran的内核开发指南：中断请求和可编程中断控制器
		</title>
		<link href="layout.css" type="text/css" rel="stylesheet">
	</head>

	<body>
		<h2><font face="Tahoma">中断请求和可编程中断控制器</font></h2>

		<p><span style="font-family: Tahoma">中断请求（</span><font face="Tahoma"><span lang="EN-US">Interrupt 
		Request</span></font><span style="font-family: Tahoma">，</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">）是由硬件设备引发的中断。一些设备在有数据就绪可读时产生一个</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">，另一些在完成一个指令时（比如把缓冲块写入磁盘）产生一个</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。可以说只要设备想获得处理器的注意，它就会产生一个</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">可以由任何设备产生，网卡、声卡、鼠标、键盘、串口，等等。</span><font face="Tahoma">
		</font>
		</p>
		<p><span style="font-family: Tahoma">任何</span><font face="Tahoma"><span lang="EN-US">IBM</span></font><span style="font-family: Tahoma">兼容</span><font face="Tahoma"><span lang="EN-US">PC</span></font><span style="font-family: Tahoma">（任何具有</span><font face="Tahoma"><span lang="EN-US">286</span></font><span style="font-family: Tahoma">或更新处理器的计算机）都有两块芯片用于处理</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。这两芯片被称为可编程中断控制器（</span><font face="Tahoma"><span lang="EN-US">Programmable 
		Interrupt Controllers</span></font><span style="font-family: Tahoma">，</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">）。这些</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">也被叫做“</span><font face="Tahoma"><span lang="EN-US">8259</span></font><span style="font-family: Tahoma">”。</span><font face="Tahoma">
		</font>
		<span style="font-family: Tahoma">一块</span><font face="Tahoma"><span lang="EN-US">8259</span></font><span style="font-family: Tahoma">作为“主”</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">控制器，而另一块则是“从”</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">控制器。从</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">控制器连接到主</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">控制器的</span><font face="Tahoma"><span lang="EN-US">IRQ2</span></font><span style="font-family: Tahoma">口。主</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">控制器则直接连接到处理器，并向其发送信号。每个</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">可以处理八个</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。主</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">负责</span><font face="Tahoma"><span lang="EN-US">0
		</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US"> 
		7</span></font><span style="font-family: Tahoma">号</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">，而从</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">负责</span><font face="Tahoma"><span lang="EN-US">8
		</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">15</span></font><span style="font-family: Tahoma">号</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。记住从控制器是连接到主</span><font face="Tahoma">
		</font>
		<span style="font-family: Tahoma">控制器的</span><font face="Tahoma"><span lang="EN-US">IRQ2</span></font><span style="font-family: Tahoma">口的：这意味着每当</span><font face="Tahoma"><span lang="EN-US">8</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">15</span></font><span style="font-family: Tahoma">号的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">发生时，</span><font face="Tahoma"><span lang="EN-US">IRQ2</span></font><span style="font-family: Tahoma">都一定会被激活。</span><font face="Tahoma">
		</font>
		</p>
		<p><span style="font-family: Tahoma">当一个设备发送一个</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">时，记住，一个中断就产生了，</span><font face="Tahoma"><span lang="EN-US">CPU</span></font><span style="font-family: Tahoma">暂停正在进行的工作，转而调用</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">来处理响应的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。然后</span><font face="Tahoma"><span lang="EN-US">CPU</span></font><span style="font-family: Tahoma">进行任何所需的动作（比如从键盘读），接着告诉产生中断的</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">自己已经运行完正确的例程。</span><font face="Tahoma"><span lang="EN-US">CPU</span></font><span style="font-family: Tahoma">向对应</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">的指令寄存器写入十六进制的控制字节</span><font face="Tahoma"><span lang="EN-US">0x20</span></font><span style="font-family: Tahoma">来告诉它中断已经结束。主</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">的控制寄存器是</span><font face="Tahoma"><span lang="EN-US">I/O</span></font><span style="font-family: Tahoma">端口</span><font face="Tahoma"><span lang="EN-US">0x20</span></font><span style="font-family: Tahoma">，而从</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">则是</span><font face="Tahoma"><span lang="EN-US">0xA0</span></font><span style="font-family: Tahoma">。</span></p>
		<span style="font-size: 12.0pt; font-family: Tahoma">在我们编写自己的</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ</span><span style="font-size: 12.0pt; font-family: Tahoma">管理代码之前，我们需要知道</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ0</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma"> 
		IRQ7</span><span style="font-size: 12.0pt; font-family: Tahoma">原来是映射到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IDT</span><span style="font-size: 12.0pt; font-family: Tahoma">的</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">8</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">15</span><span style="font-size: 12.0pt; font-family: Tahoma">号入口的，</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ8</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ15</span><span style="font-size: 12.0pt; font-family: Tahoma">则映射到了</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IDT</span><span style="font-size: 12.0pt; font-family: Tahoma">的</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">0x70</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">0x78</span><span style="font-size: 12.0pt; font-family: Tahoma">号入口。如果你记得本指南的前面章节，就会知道</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IDT</span><span style="font-size: 12.0pt; font-family: Tahoma">的</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">0</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">31</span><span style="font-size: 12.0pt; font-family: Tahoma">号入口是保留给异常的。幸运的是，中断控制器是“可编程的”：你可以改变</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ</span><span style="font-size: 12.0pt; font-family: Tahoma">所映射的</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IDT</span><span style="font-size: 12.0pt; font-family: Tahoma">入口。在本指南中，我们将把</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ0</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IRQ15</span><span style="font-size: 12.0pt; font-family: Tahoma">映射到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">IDT</span><span style="font-size: 12.0pt; font-family: Tahoma">的</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">32</span><span style="font-size: 12.0pt; font-family: Tahoma">到</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">47</span><span style="font-size: 12.0pt; font-family: Tahoma">号入口。开始之前，我们需要把一些</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">ISR</span><span style="font-size: 12.0pt; font-family: Tahoma">添加到“</span><span lang="EN-US" style="font-size: 12.0pt; font-family: Tahoma">start.asm</span><span style="font-size: 12.0pt; font-family: Tahoma">”以便为我们的中断服务：</span><pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt">　</pre>
		<table border="1" width="100%" id="table1" style="border-collapse: collapse">
			<tr>
				<td>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">global _irq0</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">...                ; </span></font><span style="font-family: Tahoma">你来完成剩余的！</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">global _irq15</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">; 32: IRQ0</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">_irq0:</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    cli</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">    push byte 0    ; </span></font><span style="font-family: Tahoma">注意到这里没有压入一个错误代码到栈中：</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">                   ; </span></font><span style="font-family: Tahoma">我们需要压入一个伪错误码。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push byte 32</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    jmp irq_common_stub</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">...                ; </span></font><span style="font-family: Tahoma">你需要填完剩余的！</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">; 47: IRQ15</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">_irq15:</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    cli</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push byte 0</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push byte 47</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    jmp irq_common_stub</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">extern _irq_handler</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">; </span></font><span style="font-family: Tahoma">这是我们为</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">所创建的一个</span><font face="Tahoma"><span lang="EN-US">stub</span></font><span style="font-family: Tahoma">，这个</span><font face="Tahoma"><span lang="EN-US">stub</span></font><span style="font-family: Tahoma">是基于</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">的。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">; </span></font><span style="font-family: Tahoma">这在我们的</span><font face="Tahoma"><span lang="EN-US">C</span></font><span style="font-family: Tahoma">代码里被称为“</span><font face="Tahoma"><span lang="EN-US">_irq_handler</span></font><span style="font-family: Tahoma">”。我们需要在“</span><font face="Tahoma"><span lang="EN-US">irq.c</span></font><span style="font-family: Tahoma">”里创建它。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">irq_common_stub:</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    pusha</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push ds</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push es</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push fs</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push gs</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov ax, 0x10</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov ds, ax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov es, ax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov fs, ax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov gs, ax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov eax, esp</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    push eax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    mov eax, _irq_handler</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    call eax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    pop eax</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    pop gs</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    pop fs</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    pop es</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    pop ds</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    popa</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    add esp, 8</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    iret</span></font></pre>
				</td>
			</tr>
			<tr>
				<td><b><span style="font-family: Tahoma"><font size="2">
				把这块代码添加到“</font></span><span lang="EN-US" style="font-family: Tahoma"><font size="2">start.asm</font></span><span style="font-family: Tahoma"><font size="2">”</font></span></b></td>
			</tr>
		</table>
		<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span lang="EN-US">               </span></pre>
		<p><span style="font-family: Tahoma">就像本指南前面的每个章节一样，我们需要创建一个名为“</span><font face="Tahoma"><span lang="EN-US">irq.c</span></font><span style="font-family: Tahoma">”的新文件，在“</span><font face="Tahoma"><span lang="EN-US">build.bat</span></font><span style="font-family: Tahoma">”中添加适当语句以使</span><font face="Tahoma"><span lang="EN-US">GCC</span></font><span style="font-family: Tahoma">编译这个文件，并且记住添加一个新的目标文件以使</span><font face="Tahoma"><span lang="EN-US">LD</span></font><span style="font-family: Tahoma">链接进我们的内核。</span><font face="Tahoma">
		</font>
		</p>
		<table border="1" width="100%" id="table2" style="border-collapse: collapse">
			<tr>
				<td>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">#include &lt; system.h &gt;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">这是指向我们特殊</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">处理程序的</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">，用来取代常规“</span><font face="Tahoma"><span lang="EN-US">fault_handler </span></font><span style="font-family: Tahoma">”函数。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">extern void irq0();</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">...                    /* </span></font><span style="font-family: Tahoma">在这里添加剩余的入口以完成声明</span><font face="Tahoma"><span lang="EN-US"> */</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">extern void irq15();</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">这个数组实际上是函数指针的数组。我们用它来为一个给定的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">指定定制的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">处理程序。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">void *irq_routines[16] =</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">{</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    0, 0, 0, 0, 0, 0, 0, 0,</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    0, 0, 0, 0, 0, 0, 0, 0</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">};</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">为一个给定的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">安装定制的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">处理程序。</span><font face="Tahoma"><span lang="EN-US"> */</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">void irq_install_handler(int irq, void (*handler)(struct regs *r))</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">{</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    irq_routines[irq] = handler;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">}</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">为一个给定的</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">清除对应处理程序。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">void irq_uninstall_handler(int irq)</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">{</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    irq_routines[irq] = 0;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">}</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">一般情况下，</span><font face="Tahoma"><span lang="EN-US">IRQ0</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">IRQ7</span></font><span style="font-family: Tahoma">映射到</span><font face="Tahoma"><span lang="EN-US">8</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">15</span></font><span style="font-family: Tahoma">号入口。这在保护模式下是一个问题，</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">因为</span><font face="Tahoma"><span lang="EN-US">IDT</span></font><span style="font-family: Tahoma">的</span><font face="Tahoma"><span lang="EN-US">8</span></font><span style="font-family: Tahoma">号入口是双重故障异常！如果不重映射，每当</span><font face="Tahoma"><span lang="EN-US">IRQ0</span></font><span style="font-family: Tahoma">激活时，你将得</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">到的是一个双重故障异常，而不是实际上发生的中断。我们把指令传给</span><font face="Tahoma"><span lang="EN-US">PIC</span></font><span style="font-family: Tahoma">（</span><font face="Tahoma"><span lang="EN-US">8259</span></font><span style="font-family: Tahoma">），</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">将其</span><font face="Tahoma"><span lang="EN-US">IRQ0</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">IRQ15</span></font><span style="font-family: Tahoma">重映射到</span><font face="Tahoma"><span lang="EN-US">IDT</span></font><span style="font-family: Tahoma">的</span><font face="Tahoma"><span lang="EN-US">32</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">47</span></font><span style="font-family: Tahoma">号入口。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">*/</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">void irq_remap(void)</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">{</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0x20, 0x11);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0xA0, 0x11);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0x21, 0x20);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0xA1, 0x28);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0x21, 0x04);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0xA1, 0x02);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0x21, 0x01);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0xA1, 0x01);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0x21, 0x0);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0xA1, 0x0);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">}</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">我们先重映射中断控制器，然后把适当的</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">安装到</span><font face="Tahoma"><span lang="EN-US">IDT</span></font><span style="font-family: Tahoma">的正确入口。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">这就像是在安装异常处理程序。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">*/</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">void irq_install()</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">{</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    irq_remap();</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    idt_set_gate(32, (unsigned)irq0, 0x08, 0x8E);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    ...          /* You need to add the rest! */</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    idt_set_gate(47, (unsigned)irq15, 0x08, 0x8E);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">}</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">/* </span></font><span style="font-family: Tahoma">每个</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">的</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">都指向这个函数，而不是“</span><font face="Tahoma"><span lang="EN-US">isrs.c</span></font><span style="font-family: Tahoma">”中的“</span><font face="Tahoma"><span lang="EN-US">fault_handler</span></font><span style="font-family: Tahoma">”。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  IRQ</span></font><span style="font-family: Tahoma">控制器需要知道你做了什么来为它服务，所以你需要给它们发送一个“中断结束”</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">（</span><font face="Tahoma"><span lang="EN-US">EOI</span></font><span style="font-family: Tahoma">，</span><font face="Tahoma"><span lang="EN-US">0x20</span></font><span style="font-family: Tahoma">）指令。这里有两个</span><font face="Tahoma"><span lang="EN-US">8259</span></font><span style="font-family: Tahoma">芯片：前一个在</span><font face="Tahoma"><span lang="EN-US">0x20</span></font><span style="font-family: Tahoma">端口，后一个在</span><font face="Tahoma"><span lang="EN-US">0xA0 </span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">端口。如果后一个控制器（</span><font face="Tahoma"><span lang="EN-US">8</span></font><span style="font-family: Tahoma">到</span><font face="Tahoma"><span lang="EN-US">15</span></font><span style="font-family: Tahoma">号</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">）获得一个中断，你需要同时知道两个控制</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">器的中断情况，否则你只是给前一个控制器发送</span><font face="Tahoma"><span lang="EN-US">EOI</span></font><span style="font-family: Tahoma">指令，而漏掉后一个。这样不发</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">*  </span></font><span style="font-family: Tahoma">送</span><font face="Tahoma"><span lang="EN-US">EOI</span></font><span style="font-family: Tahoma">，你将不能再激活任何</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">。</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">*/</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">void irq_handler(struct regs *r)</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">{</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">    /* </span></font><span style="font-family: Tahoma">这是一个空的函数指针。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    void (*handler)(struct regs *r);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">    /* </span></font><span style="font-family: Tahoma">查找是否有一个对应的定制处理程序，然后运行它。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    handler = irq_routines[r-&gt;int_no - 32];</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    if (handler)</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    {</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">        handler(r);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    }</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">    /* </span></font><span style="font-family: Tahoma">如果</span><font face="Tahoma"><span lang="EN-US">IDT</span></font><span style="font-family: Tahoma">入口号大于</span><font face="Tahoma"><span lang="EN-US">40</span></font><span style="font-family: Tahoma">，我们还需要发送一个</span><font face="Tahoma"><span lang="EN-US">EOI</span></font><span style="font-family: Tahoma">到从控制器。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    if (r-&gt;int_no &gt;= 40)</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    {</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">        outportb(0xA0, 0x20);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    }</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">&nbsp;</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Courier New; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><font face="Tahoma"><span lang="EN-US">  &nbsp;&nbsp;/* </span></font><span style="font-family: Tahoma">任何情况下，我们都需要发送</span><font face="Tahoma"><span lang="EN-US">EOI</span></font><span style="font-family: Tahoma">到主中断控制器。</span><font face="Tahoma"><span lang="EN-US">*/</span></font></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">    outportb(0x20, 0x20);</span></font></pre>
				<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 24.0pt; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><font color="#800000"><span lang="EN-US">}</span></font></pre>
				</td>
			</tr>
			<tr>
				<td><b><span style="font-family: Tahoma"><font size="2">“</font></span><span lang="EN-US" style="font-family: Tahoma"><font size="2">irq.c</font></span><span style="font-family: Tahoma"><font size="2">”的内容</font></span></b></td>
			</tr>
		</table>
		<pre style="font-size: 10.0pt; font-family: Tahoma; margin-left: 0cm; margin-right: 0cm; margin-top: 0cm; margin-bottom: .0001pt"><span lang="EN-US">               </span></pre>
		<p><span style="font-family: Tahoma">为了真正地安装处理</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">的</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">，我们需要在“</span><font face="Tahoma"><span lang="EN-US">main.c</span></font><span style="font-family: Tahoma">”的“</span><font face="Tahoma"><span lang="EN-US">main</span></font><span style="font-family: Tahoma">”函数中调用“</span><font face="Tahoma"><span lang="EN-US">irq_install</span></font><span style="font-family: Tahoma">”。在你添加调用之前，你需要在“</span><font face="Tahoma"><span lang="EN-US">system.h</span></font><span style="font-family: Tahoma">”中为“</span><font face="Tahoma"><span lang="EN-US">irq_install</span></font><span style="font-family: Tahoma">”、“</span><font face="Tahoma"><span lang="EN-US">irq_install_handler</span></font><span style="font-family: Tahoma">”和“</span><font face="Tahoma"><span lang="EN-US">irq_uninstall_handler</span></font><span style="font-family: Tahoma">”添加原型。“</span><font face="Tahoma"><span lang="EN-US">irq_install_handler</span></font><span style="font-family: Tahoma">”为我们的设备在给定</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">下安装特别的定制</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">子处理程序。在后面的章节中，我们将使用“</span><font face="Tahoma"><span lang="EN-US">irq_install_handler</span></font><span style="font-family: Tahoma">”来为系统时钟（可编程计时器</span><font face="Tahoma"><span lang="EN-US">PIT</span></font><span style="font-family: Tahoma">－</span><font face="Tahoma"><span lang="EN-US">IRQ0</span></font><span style="font-family: Tahoma">）和键盘（</span><font face="Tahoma"><span lang="EN-US">IRQ1</span></font><span style="font-family: Tahoma">）。在我们安装号自己的异常</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">之后，紧接着添加“</span><font face="Tahoma"><span lang="EN-US">irq_install</span></font><span style="font-family: Tahoma">”到“</span><font face="Tahoma"><span lang="EN-US">main.c</span></font><span style="font-family: Tahoma">”的“</span><font face="Tahoma"><span lang="EN-US">main</span></font><span style="font-family: Tahoma">”函数中。添加下面这行后，马上就可以允许</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">发生了：</span><font face="Tahoma"><span lang="EN-US"><br>
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __asm__ __volatile__ (&quot;sti&quot;); </span>
		</font></p>
		<p><span style="font-family: Tahoma">恭喜你，你跟随我们一步步地创建了一个可以处理</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">和异常的简单内核，安装了一个</span><font face="Tahoma"><span lang="EN-US">IDT
		</span></font><span style="font-family: Tahoma">，并且用一个定制的</span><font face="Tahoma"><span lang="EN-US">GDT</span></font><span style="font-family: Tahoma">代替了原来</span><font face="Tahoma"><span lang="EN-US">GRUB</span></font><span style="font-family: Tahoma">所装载的</span><font face="Tahoma"><span lang="EN-US">GDT</span></font><span style="font-family: Tahoma">。如果你理解了前面提到的所有内容，你就通过了操作系统开发中的最大障碍之一。大多数业余的</span><font face="Tahoma"><span lang="EN-US">OS</span></font><span style="font-family: Tahoma">开发者不能顺利地安装</span><font face="Tahoma"><span lang="EN-US">ISR</span></font><span style="font-family: Tahoma">和</span><font face="Tahoma"><span lang="EN-US">IDT</span></font><span style="font-family: Tahoma">。下一步，我们将学习最简单的设备――可编程计时器（</span><font face="Tahoma"><span lang="EN-US">PIT</span></font><span style="font-family: Tahoma">）是如何使用</span><font face="Tahoma"><span lang="EN-US">IRQ</span></font><span style="font-family: Tahoma">的。</span></p>

		<table cols="150, *, 150" width="100%">
			<tr>
				<td align="left" width="150">
					<font face="Tahoma">
					<a href="isrs.htm">&lt;&lt; 中断服务例程 </a>
					</font>
				</td>
				<td align="center" width="*">
					<font face="Tahoma">
					<a href="mailto:friesenb@gmail.com">联系Brandon F.</a>
					</font>
				</td>
				<td align="right" width="150">
					<font face="Tahoma">
					<a href="pit.htm">可编程间隔定时器 &gt;&gt;</a>
					</font>
				</td>
			</tr>
		</table>
	</body>
</html>